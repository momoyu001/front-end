<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Vue3设计与实现</title>
    </head>
    <body>
        <div class="btn-box">
            <input type="text" id="input" />
            <button onclick="handleButtonClick" id="button">在输入框中输入后，点击按钮修改原始对象的值</button>
        </div>
        <div id="app"></div>
        <script>
            /**
             * 响应系统的实现
             * **/

            // 原始数据
            let data = {
                name: 'lixia',
                age: 20,
                ok: true,
            };

            // proxy 代理对象
            const proxyObj = new Proxy(data, {
                get(target, key) {
                    console.log('get 拦截');
                    track(target, key);
                    return target[key];
                },
                set(target, key, value) {
                    console.log('set 拦截');
                    target[key] = value;
                    trigger(target, key);
                    return true;
                },
            });

            // 存储副作用函数 key 为 target，value 为一个 map，map - 存储各个 key 具体的副作用函数 key 为 key，value 为这个 key 相关的副作用函数
            const bucket = new WeakMap();

            // 跟踪函数，在目标对象的 get 拦截中调用，注册副作用函数
            const track = (target, key) => {
                if (!activeEffectFn) return;

                let depsMap = bucket.get(target);

                // 如果不存在，就新建一个
                if (!depsMap) {
                    bucket.set(target, depsMap = new Map());
                }

                let deps = depsMap.get(key);

                if (!deps) {
                    depsMap.set(key, deps = new Set())
                }

                deps.add(activeEffectFn);
            };

            // 触发函数，在目标对象的 set 拦截中调用，调用副作用函数
            const trigger = (target, key) => {
                let depsMap = bucket.get(target);
                if (!depsMap) return;
                let effects = depsMap.get(key);
                effects && effects.forEach(fn => fn());
            };

            // 全局变量
            let activeEffectFn;
            // 注册副作用函数
            const effect = fn => {
                activeEffectFn = fn;
                fn();
            };

            // 副作用函数
            const effectFn = () => {
                console.log('副作用函数');
                // document.getElementById('app').textContent = proxyObj.name;
                document.getElementById('app').textContent = proxyObj.ok ? proxyObj.name : '复现分支场景';
            };

            const input = document.getElementById('input');

            // 按钮点击事件
            const handleButtonClick = () => {
                console.log('点击事件函数');
                proxyObj.name = input.value;
            };
            document.getElementById('button').addEventListener('click', handleButtonClick);

            // 立即执行函数，一打开页面就会执行，首先执行一次展示页面内容
            (function () {
                effect(effectFn);
                setTimeout(()=> {
                    proxyObj.age = 120;
                    proxyObj.ok = false;
                }, 3000)
            })();
        </script>
    </body>
</html>
